##########################
# docker-compose.example.yml
# 달러마이닝 자동매매 봇 설정 예제
##########################

##########################
# 네트워크 설정 옵션
##########################
# 
# 옵션 1: 독립 실행 (포트 직접 노출)
# - 리버스 프록시 없이 단독으로 실행할 때 사용
# - 아래 'ports' 주석을 해제하고, networks 섹션을 삭제
#
# 옵션 2: 외부 네트워크 연결 (리버스 프록시 사용)
# - Traefik, Nginx Proxy Manager 등과 함께 사용할 때
# - 먼저 외부 네트워크 생성: docker network create proxy_net
# - networks 섹션의 external: true 유지
#
# 옵션 3: 내부 네트워크만 사용
# - 다른 컨테이너와 통신만 필요할 때
# - external: true를 삭제하고 일반 네트워크로 변경
##########################

networks:
  # 옵션 2: 리버스 프록시용 외부 네트워크
  # 사전에 생성 필요: docker network create proxy_net
  proxy_net:
    external: true
  
  # 옵션 3: 내부 네트워크 (외부 네트워크 불필요시)
  # internal_net:
  #   driver: bridge

services:
  trading-bot:
    build: ./
    container_name: trading-bot
    restart: always
    
    ##########################
    # 포트 설정
    ##########################
    # 옵션 1: 직접 포트 노출 (리버스 프록시 없이 사용)
    # ports:
    #   - "8000:8000"           # http://localhost:8000 으로 접속
    # 
    # 옵션 1-1: 다른 포트 사용
    # ports:
    #   - "8121:8000"           # http://localhost:8121 으로 접속
    #
    # 옵션 2: 리버스 프록시 사용시 포트 노출 불필요
    # (networks로 연결된 프록시가 내부 8000 포트로 접근)
    
    ##########################
    # 환경 변수
    ##########################
    env_file:
      - ./.env                  # 환경변수 파일 로드
    
    environment:
      - TZ=Asia/Seoul           # 타임존 설정 (한국시간)
    
    ##########################
    # 실행 명령
    ##########################
    command: >
      uvicorn app.main:app 
      --host 0.0.0.0 
      --port 8000
      --proxy-headers
      --forwarded-allow-ips "*"
    
    # 개발 모드 (핫 리로드 활성화)
    # command: >
    #   uvicorn app.main:app 
    #   --host 0.0.0.0 
    #   --port 8000 
    #   --reload 
    #   --reload-dir app
    #   --proxy-headers
    #   --forwarded-allow-ips "*"
    
    ##########################
    # 볼륨 마운트
    ##########################
    volumes:
      # 필수 볼륨
      - ./trading.db:/app/trading.db        # SQLite 데이터베이스
      - ./logs:/app/logs                     # 로그 파일
      - ./data:/app/data                     # YouTube 채널/요약 데이터
      - ./token_cache.json:/app/token_cache.json  # API 토큰 캐시
      
      # 개발 모드용 (핫 리로드시 필요)
      # - ./app:/app/app                     # 소스코드 마운트
      # - ./.env:/app/.env                   # 환경변수 파일 마운트
    
    ##########################
    # 네트워크 연결
    ##########################
    networks:
      - proxy_net               # 리버스 프록시 네트워크
      # - internal_net          # 내부 네트워크만 사용시

##########################
# 사용 예시
##########################
#
# 1. 처음 설정
#    cp docker-compose.example.yml docker-compose.yml
#    cp .env.example .env
#    # .env 파일 수정
#
# 2. 외부 네트워크 생성 (리버스 프록시 사용시)
#    docker network create proxy_net
#
# 3. 빈 파일 생성 (최초 실행 전)
#    touch trading.db token_cache.json
#    mkdir -p logs data
#
# 4. 컨테이너 실행
#    docker compose up -d
#
# 5. 로그 확인
#    docker compose logs -f
#
# 6. 컨테이너 중지
#    docker compose down
#
##########################
